<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solo Campaign Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#faf6f0;
      --panel:#ffffff;
      --card:#fdf9f2;
      --header:#1e0f0a;
      --nav:#2d180f;
      --accent:#d4af37;
      --accent2:#a67c00;
      --text:#2c1a0d;
      --muted:#7a5c3a;
      --danger:#9f2b2b;
      --success:#2b7a3d;
      --border:#d9c2a3;
      --shadow: 0 8px 24px rgba(0,0,0,0.12);
      --radius: 16px;
      --transition: all 0.20s ease;
      --focus: 0 0 0 3px rgba(212,175,55,0.25);
    }
    body.dark{
      --bg:#0f0a05;
      --panel:#1a120d;
      --card:#221a12;
      --header:#000000;
      --nav:#1a0f0a;
      --accent:#e6c84a;
      --accent2:#b89a2f;
      --text:#f0e0d0;
      --muted:#a68f6e;
      --border:#3d2f1f;
      --shadow: 0 8px 32px rgba(0,0,0,0.42);
      --focus: 0 0 0 3px rgba(230,200,74,0.18);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.55;
      transition: var(--transition);
    }

    header{
      background:var(--header);
      color:#f4e4d3;
      padding:18px 16px;
      text-align:center;
      box-shadow: 0 4px 14px rgba(0,0,0,0.22);
    }
    header h1{
      font-family:'Cinzel', serif;
      font-size:26px;
      margin:0 0 6px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    header p{ opacity:.9; font-size:14px; }

    nav{
      background:var(--nav);
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      padding:12px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    nav button{
      background:transparent;
      border:none;
      color:#f4e4d3;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition:var(--transition);
      font-weight:500;
    }
    nav button:hover{ background:rgba(212,175,55,0.18); }
    nav button.active{
      background:var(--accent);
      color:#1e0f0a;
      font-weight:700;
    }
    nav button.secondary{
      opacity:0.88;
      border:1px solid rgba(244,228,211,0.18);
    }

    main{
      max-width:1300px;
      margin:0 auto;
      padding:18px 14px 36px;
    }

    section{
      display:none;
      animation: fadeIn 0.35s ease;
    }
    section.active{ display:block; }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(8px);}
      to{opacity:1; transform:none;}
    }

    h2{
      font-family:'Cinzel', serif;
      font-size:22px;
      margin:0 0 14px;
      color:var(--accent);
      letter-spacing:0.2px;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .spacer{ flex:1; }
    .muted{ color:var(--muted); opacity:.92; }
    .hint{ font-size:13px; color:var(--muted); opacity:.85; margin-top:6px; }

    .btn{
      background:var(--accent2);
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:13.5px;
      font-weight:600;
      transition:var(--transition);
      user-select:none;
    }
    .btn:hover{ background:var(--accent); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0px); }
    .btn.ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
    }
    .btn.danger{ background:var(--danger); }
    .btn.success{ background:var(--success); }
    .btn.small{ padding:7px 10px; font-size:13px; }

    input, textarea, select{
      width:100%;
      padding:11px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-family:inherit;
      font-size:14px;
      transition:var(--transition);
    }
    input:focus, textarea:focus, select:focus{
      outline:none;
      box-shadow:var(--focus);
      border-color:var(--accent);
    }
    textarea{ resize:vertical; min-height:100px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(330px, 1fr));
      gap:16px;
      margin-top:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      transition:var(--transition);
    }
    .card:hover{ transform:translateY(-3px); box-shadow: 0 14px 36px rgba(0,0,0,0.16); }

    .pill{
      background:rgba(212,175,55,0.20);
      color:var(--accent2);
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }
    .hr{ height:1px; background:var(--border); margin:14px 0; opacity:0.7; }

    .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .three{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
    @media(max-width:900px){ .three{ grid-template-columns:1fr; } }
    @media(max-width:760px){ .two{ grid-template-columns:1fr; } }

    #saveDot{
      position:fixed;
      top:16px;
      right:16px;
      width:12px; height:12px;
      border-radius:50%;
      background:var(--success);
      opacity:0;
      transition:opacity 0.35s;
      z-index:200;
      box-shadow: 0 0 0 3px rgba(43,122,61,0.18);
    }
    #saveDot.show{ opacity:1; }

    #errorBar{
      display:none;
      max-width:1300px;
      margin:10px auto 0;
      padding:12px 14px;
      border-radius:14px;
      background:#ffe0e0;
      border:1px solid #e88;
      color:#900;
    }
    body.dark #errorBar{
      background:#3d1b1b; color:#ffbbbb; border-color:#a44;
    }

    .bigResult{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.03);
      min-height:52px;
      display:flex;
      align-items:center;
      font-weight:700;
    }
    body.dark .bigResult{ background:rgba(255,255,255,0.04); }

    .soloChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(212,175,55,0.12);
      font-size:13px;
      font-weight:700;
      user-select:none;
    }

    .map-container{
      position:relative;
      overflow:hidden;
      border-radius:var(--radius);
      border:2px solid var(--border);
      background:#000;
      margin-top:14px;
      height:70vh;
    }
    #mapImg{
      width:100%;
      height:100%;
      object-fit:contain;
      display:none;
      cursor:grab;
      transition:transform 0.08s;
    }
    #mapImg.dragging{ cursor:grabbing; }

    .turn{
      border:2px solid var(--accent);
      border-radius:var(--radius);
    }
    .init-order{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:12px;
      background:var(--card);
      border-radius:12px;
      border:1px solid var(--border);
      margin-top:12px;
    }
    .init-item{
      padding:6px 10px;
      background:rgba(212,175,55,0.18);
      border-radius:10px;
      font-size:13px;
      font-weight:700;
    }
    .init-item.current{
      background:var(--accent);
      color:#1e0f0a;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      border:1px solid var(--border);
      border-bottom-width:2px;
      border-radius:8px;
      padding:2px 6px;
      font-size:12px;
      opacity:.85;
    }
  </style>
</head>

<body>
  <div id="saveDot"></div>

  <header>
    <h1>Solo Campaign Panel</h1>
    <p>–°–æ–ª–æ-–∫–∞–º–ø–∞–Ω–∏—è: –∂—É—Ä–Ω–∞–ª, –ø–µ—Ä—Å–æ–Ω–∞–∂, –±–æ–π, –∫–≤–µ—Å—Ç—ã –∏ –æ—Ä–∞–∫—É–ª—ã ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ</p>
  </header>

  <nav>
    <button data-tab="dashboard" class="active">üè† –°–æ–ª–æ</button>
    <button data-tab="journal">üìÖ –ñ—É—Ä–Ω–∞–ª</button>
    <button data-tab="character">üßô –ú–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂</button>
    <button data-tab="combat">‚öîÔ∏è –ë–æ–π</button>
    <button data-tab="quests">üìú –ö–≤–µ—Å—Ç—ã</button>
    <button data-tab="world">üó∫Ô∏è –ú–∏—Ä</button>
    <button data-tab="map">üß≠ –ö–∞—Ä—Ç–∞</button>
    <button id="exportBtn" class="secondary">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
    <button id="importBtn" class="secondary">üì• –ò–º–ø–æ—Ä—Ç</button>
    <button id="themeBtn" class="secondary">üåô –¢—ë–º–Ω–∞—è</button>
  </nav>

  <div id="errorBar"><b>–û—à–∏–±–∫–∞:</b> <span id="errorText"></span></div>

  <main>
    <!-- SOLO DASHBOARD -->
    <section id="dashboard" class="active">
      <div class="row">
        <h2>–°–æ–ª–æ-—Ü–µ–Ω—Ç—Ä</h2>
        <div class="spacer"></div>
        <span class="soloChip">üß† –û—Ä–∞–∫—É–ª ‚Ä¢ üé≤ –ö—É–±—ã ‚Ä¢ ‚ö° –¢–≤–∏—Å—Ç—ã</span>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row">
            <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–°—Ü–µ–Ω–∞ —Å–µ–π—á–∞—Å</h3>
            <div class="spacer"></div>
            <span class="pill" id="scenePill">–°—Ü–µ–Ω–∞</span>
          </div>
          <label>–ö–æ—Ä–æ—Ç–∫–æ: –≥–¥–µ —è –∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</label>
          <input id="sceneTitle" placeholder="–ù–∞–ø—Ä.: –ó–∞–±—Ä–æ—à–µ–Ω–Ω–∞—è —á–∞—Å–æ–≤–Ω—è, –ø–æ–ª–Ω–æ—á—å">
          <label>–¶–µ–ª—å —Å—Ü–µ–Ω—ã (—á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –¥–æ–±–∏—Ç—å—Å—è)</label>
          <input id="sceneGoal" placeholder="–ù–∞–ø—Ä.: –ù–∞–π—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—è">
          <label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea id="sceneNotes" rows="5" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, NPC, –∑–∞—Ü–µ–ø–∫–∏..."></textarea>

          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="saveSceneBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω—É</button>
            <button class="btn ghost" id="newSceneBtn">‚ú® –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞</button>
          </div>
          <div class="hint">–°–æ–≤–µ—Ç: –¥–ª—è —Å–æ–ª–æ –∏–≥—Ä—ã ‚Äú—Å—Ü–µ–Ω–∞‚Äù ‚Äî —ç—Ç–æ –∫–∞–∫ –∫–∞–¥—Ä –≤ –∫–∏–Ω–æ. –û–¥–Ω–∞ —Ü–µ–ª—å ‚Üí –æ–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
        </div>

        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–û—Ä–∞–∫—É–ª –î–∞/–ù–µ—Ç</h3>

          <label>–í–æ–ø—Ä–æ—Å (–Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –î–∞/–ù–µ—Ç)</label>
          <input id="oracleQ" placeholder="–ù–∞–ø—Ä.: –ï—Å—Ç—å –ª–∏ –∑–¥–µ—Å—å —Å–∫—Ä—ã—Ç–∞—è –¥–≤–µ—Ä—å?">

          <div class="two" style="margin-top:10px;">
            <div>
              <label>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</label>
              <select id="oracleOdds">
                <option value="very_unlikely">–û—á–µ–Ω—å –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ</option>
                <option value="unlikely">–ú–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ</option>
                <option value="50" selected>50/50</option>
                <option value="likely">–í–µ—Ä–æ—è—Ç–Ω–æ</option>
                <option value="very_likely">–û—á–µ–Ω—å –≤–µ—Ä–æ—è—Ç–Ω–æ</option>
              </select>
            </div>
            <div>
              <label>–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
              <div class="bigResult" id="oracleResult">‚Äî</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="oracleRollBtn">üé≤ –°–ø—Ä–æ—Å–∏—Ç—å –æ—Ä–∞–∫—É–ª</button>
            <button class="btn ghost" id="oracleClearBtn">–°–±—Ä–æ—Å</button>
          </div>

          <div class="hr"></div>

          <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–¢–≤–∏—Å—Ç / –°–æ–±—ã—Ç–∏–µ</h3>
          <div class="two">
            <div>
              <label>–¢–≤–∏—Å—Ç</label>
              <div class="bigResult" id="twistResult">‚Äî</div>
            </div>
            <div>
              <label>–°—Ü–µ–Ω–∞-—Å—Ç–∞—Ä—Ç (–±—ã—Å—Ç—Ä—ã–π —Å–µ—Ç–∞–ø)</label>
              <div class="bigResult" id="sceneSeedResult">‚Äî</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="twistBtn">‚ö° –¢–≤–∏—Å—Ç</button>
            <button class="btn" id="sceneSeedBtn">üé≠ –°—Ü–µ–Ω–∞</button>
          </div>

          <div class="hint">–°–æ–ª–æ-—Ñ–æ–∫—É—Å: –∫–æ–≥–¥–∞ ‚Äú–Ω–µ –∑–Ω–∞–µ—à—å —á—Ç–æ –¥–∞–ª—å—à–µ‚Äù ‚Äî –Ω–∞–∂–∏–º–∞–π ‚Äú–°—Ü–µ–Ω–∞‚Äù –∏–ª–∏ ‚Äú–¢–≤–∏—Å—Ç‚Äù –∏ –∏–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è.</div>
        </div>

        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–ö—É–±—ã –∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</h3>
          <div class="three">
            <div>
              <label>–ö—É–±</label>
              <select id="dieSelect">
                <option value="4">d4</option>
                <option value="6">d6</option>
                <option value="8">d8</option>
                <option value="10">d10</option>
                <option value="12">d12</option>
                <option value="20" selected>d20</option>
                <option value="100">d100</option>
              </select>
            </div>
            <div>
              <label>–ö–æ–ª-–≤–æ</label>
              <input id="dieCount" type="number" min="1" value="1">
            </div>
            <div>
              <label>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä</label>
              <input id="dieMod" type="number" value="0">
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="rollDiceBtn">üé≤ –ë—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn ghost" id="copyDiceBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="bigResult" id="diceResult" style="margin-top:10px;">‚Äî</div>

          <div class="hr"></div>

          <div class="two">
            <div>
              <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">NPC</h3>
              <div class="bigResult" id="npcResult">‚Äî</div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="npcBtn">üßë‚Äçü§ù‚Äçüßë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn ghost" id="npcToWorldBtn">‚ûï –í ‚Äú–ú–∏—Ä‚Äù</button>
              </div>
            </div>
            <div>
              <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–ù–∞—Ö–æ–¥–∫–∞</h3>
              <div class="bigResult" id="lootResult">‚Äî</div>
              <div class="row" style="margin-top:10px;">
                <button class="btn" id="lootBtn">üéÅ –ù–∞—Ö–æ–¥–∫–∞</button>
                <button class="btn ghost" id="logLootBtn">üìù –í –∂—É—Ä–Ω–∞–ª</button>
              </div>
            </div>
          </div>

          <div class="hint">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã —Å–¥–µ–ª–∞–Ω—ã –ø–æ–¥ —Å–æ–ª–æ: –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å ‚Äú—Å–º—ã—Å–ª‚Äù –∏ –¥–≤–∏–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>
        </div>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="journal">
      <div class="row">
        <h2>–ñ—É—Ä–Ω–∞–ª —Å–µ—Å—Å–∏–π</h2>
        <div class="spacer"></div>
        <button class="btn" id="addSessionBtn">‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
      </div>
      <div class="hint">–î–ª—è —Å–æ–ª–æ: –ª—É—á—à–µ –ø–∏—Å–∞—Ç—å –Ω–µ ‚Äú—á—Ç–æ –±—ã–ª–æ‚Äù, –∞ ‚Äú—á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å‚Äù: –Ω–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –∑–∞—Ü–µ–ø–∫–∏.</div>
      <div id="sessionsGrid" class="grid"></div>
    </section>

    <!-- CHARACTER (single) -->
    <section id="character">
      <div class="row">
        <h2>–ú–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂</h2>
        <div class="spacer"></div>
        <button class="btn ghost" id="resetCharBtn">–°–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
      </div>

      <div class="grid">
        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–õ–∏—Å—Ç</h3>
          <div class="two">
            <div>
              <label>–ò–º—è</label>
              <input id="pcName">
            </div>
            <div>
              <label>–†–∞—Å–∞ / –ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</label>
              <input id="pcRace">
            </div>
          </div>

          <div class="two">
            <div>
              <label>–ö–ª–∞—Å—Å / –†–æ–ª—å</label>
              <input id="pcClass">
            </div>
            <div>
              <label>–£—Ä–æ–≤–µ–Ω—å</label>
              <input id="pcLevel" type="number" min="1" max="20">
            </div>
          </div>

          <div class="two">
            <div>
              <label>HP</label>
              <input id="pcHp" type="number" min="0">
            </div>
            <div>
              <label>Max HP</label>
              <input id="pcMaxHp" type="number" min="0">
            </div>
          </div>

          <div class="hr"></div>

          <label>–ö—Ä–∞—Ç–∫–æ: –º–æ—Ç–∏–≤–∞—Ü–∏—è / —Ü–µ–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
          <input id="pcDrive" placeholder="–ù–∞–ø—Ä.: –∏—Å–∫—É–ø–∏—Ç—å –≤–∏–Ω—É / –Ω–∞–π—Ç–∏ —Å–µ—Å—Ç—Ä—É">

          <label>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å / –≤–∞–∂–Ω–æ–µ</label>
          <textarea id="pcNotes" rows="6"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn success" id="savePcBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span class="muted">HP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –±–æ–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</span>
          </div>
        </div>

        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–°–æ–ª–æ-–º–µ—Ç—Ä–∏–∫–∏</h3>
          <div class="hint">–≠—Ç–æ –Ω–µ ‚Äú–ø—Ä–∞–≤–∏–ª–∞‚Äù, –∞ —á—Ç–æ–±—ã –¥–µ—Ä–∂–∞—Ç—å —Ç–µ–º–ø –∏ –¥—Ä–∞–º—É.</div>

          <label>–£–≥—Ä–æ–∑–∞ / –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (0‚Äì10)</label>
          <input id="threat" type="range" min="0" max="10">
          <div class="row" style="justify-content:space-between;">
            <span class="muted">–°–ø–æ–∫–æ–π–Ω–æ</span>
            <span class="pill" id="threatPill">0</span>
            <span class="muted">–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
          </div>

          <div class="hr"></div>

          <label>–ü—Ä–æ–≥—Ä–µ—Å—Å ‚Äú–±–æ–ª—å—à–æ–π —Ü–µ–ª–∏‚Äù (0‚Äì10)</label>
          <input id="goalProg" type="range" min="0" max="10">
          <div class="row" style="justify-content:space-between;">
            <span class="muted">–°—Ç–∞—Ä—Ç</span>
            <span class="pill" id="goalProgPill">0</span>
            <span class="muted">–§–∏–Ω–∞–ª</span>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="soloCheckpointBtn">üß∑ –ß–µ–∫–ø–æ–∏–Ω—Ç –≤ –∂—É—Ä–Ω–∞–ª</button>
            <button class="btn ghost" id="soloPushBtn">‚ö° –ü–æ–¥–Ω—è—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ</button>
          </div>

          <div class="hint">‚Äú–ü–æ–¥–Ω—è—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ‚Äù ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –∑–∞—Å—Ç–∞–≤–∏—Ç—å –º–∏—Ä —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ–±—è.</div>
        </div>
      </div>
    </section>

    <!-- COMBAT -->
    <section id="combat">
      <div class="row">
        <h2>–¢—Ä–µ–∫–µ—Ä –±–æ—è</h2>
        <div class="spacer"></div>
        <span class="pill" id="roundPill">–†–∞—É–Ω–¥: 1</span>
        <span class="pill" id="turnPill">–•–æ–¥: ‚Äî</span>
      </div>

      <div class="init-order" id="initOrder"></div>

      <div class="grid">
        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>

          <div class="hr"></div>

          <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–¢—ã</h3>
          <div class="row">
            <button class="btn" id="addPcToCombatBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            <button class="btn ghost" id="syncPcCombatBtn">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å HP</button>
          </div>
          <div class="hint">–°–æ–ª–æ: —Ç—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—à—å –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—É—Ç—å HP/MaxHP –≤ –±–æ–π –∏–∑ —Å–≤–æ–µ–≥–æ –ª–∏—Å—Ç–∞.</div>

          <div class="hr"></div>

          <h3 style="font-family:'Cinzel',serif;color:var(--accent); margin-bottom:10px;">–í—Ä–∞–≥–∏</h3>
          <div class="two">
            <div><label>–ò–º—è</label><input id="mobName" value="–ì–æ–±–ª–∏–Ω"></div>
            <div><label>–ö–æ–ª-–≤–æ</label><input id="mobCount" type="number" value="1" min="1"></div>
          </div>
          <div class="two">
            <div><label>HP</label><input id="mobMaxHp" type="number" value="7" min="0"></div>
            <div><label>–ú–æ–¥. –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã</label><input id="mobInitMod" type="number" value="2"></div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="addMobBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn ghost" id="clearCombatBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn" id="rollInitBtn">üé≤ –ë—Ä–æ—Å–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É</button>
            <button class="btn ghost" id="prevTurnBtn">‚¨ÖÔ∏è</button>
            <button class="btn" id="nextTurnBtn">‚û°Ô∏è</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn ghost" id="newRoundBtn">‚è≠Ô∏è –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥</button>
            <button class="btn ghost" id="sortInitBtn">‚ÜïÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <div class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: <span class="kbd">‚û°Ô∏è</span> —É–¥–æ–±–Ω–æ –∂–∞—Ç—å –∫–∞–∫ ‚Äú—Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä‚Äù. –í —Å–æ–ª–æ –Ω–µ –Ω–∞–¥–æ —É—Å–ª–æ–∂–Ω—è—Ç—å.</div>
        </div>

        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
          <div id="combatGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); margin-top:12px;"></div>
        </div>
      </div>
    </section>

    <!-- QUESTS -->
    <section id="quests">
      <div class="row">
        <h2>–ö–≤–µ—Å—Ç—ã –∏ —Ü–µ–ª–∏</h2>
        <div class="spacer"></div>
        <button class="btn" id="addQuestBtn">‚ûï –ù–æ–≤—ã–π –∫–≤–µ—Å—Ç</button>
      </div>
      <div class="hint">–°–æ–ª–æ: –¥–µ—Ä–∂–∏ 1‚Äì2 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–∞. –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî ‚Äú—Ñ–æ–Ω‚Äù, –∏–Ω–∞—á–µ —Ä–∞—Å–ø–∞–¥ —Ç–µ–º–ø–∞.</div>
      <div id="questsGrid" class="grid"></div>
    </section>

    <!-- WORLD -->
    <section id="world">
      <div class="row">
        <h2>–ú–∏—Ä</h2>
        <div class="spacer"></div>
        <button class="btn" id="addNpcBtn">‚ûï NPC</button>
        <button class="btn ghost" id="addLocBtn">‚ûï –õ–æ–∫–∞—Ü–∏—è</button>
      </div>

      <div class="grid">
        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">NPC</h3>
          <div id="npcGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr));"></div>
        </div>
        <div class="card">
          <h3 style="font-family:'Cinzel',serif;color:var(--accent);">–õ–æ–∫–∞—Ü–∏–∏</h3>
          <div id="locGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr));"></div>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section id="map">
      <div class="row">
        <h2>–ö–∞—Ä—Ç–∞ –∫–∞–º–ø–∞–Ω–∏–∏</h2>
        <div class="spacer"></div>
        <button class="btn ghost" id="clearMapBtn">–£–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É</button>
      </div>
      <div class="hint">–ö–∞—Ä—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Ñ–∞–π–ª –≤ —ç—Ç–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ (—á—Ç–æ–±—ã –Ω–µ —É–±–∏–≤–∞—Ç—å —Å–µ–π–≤—ã). –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç.</div>
      <input type="file" id="mapFile" accept="image/*" style="margin-top:12px;">
      <div class="map-container" id="mapContainer">
        <img id="mapImg" alt="–ö–∞—Ä—Ç–∞">
      </div>
    </section>

    <input type="file" id="importFile" accept=".json,application/json" style="display:none;">
  </main>

  <script>
    /**********************
     * Ultra-normalized Solo App
     * - no inline handlers
     * - safe storage + debounce
     * - clean state schema + migration
     **********************/

    // DOM helpers
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => [...root.querySelectorAll(s)];

    const STORAGE_KEY = "solo_campaign_panel_v1";

    const uid = () => Date.now() + Math.floor(Math.random() * 100000);
    const asNum = (v, f=0) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : f;
    };
    const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
    const nowRu = () => new Date().toLocaleString("ru-RU");

    // Save feedback
    const saveDot = $("#saveDot");
    function flashSaved(){
      saveDot.classList.add("show");
      setTimeout(()=>saveDot.classList.remove("show"), 650);
    }
    function showError(msg){
      $("#errorText").textContent = msg;
      $("#errorBar").style.display = "block";
    }
    function clearError(){
      $("#errorBar").style.display = "none";
    }

    // Debounced save
    let saveTimer = null;
    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>saveState(), 180);
    }

    // State schema
    function defaultState(){
      return {
        version: 1,
        theme: "light",
        scene: { title:"", goal:"", notes:"", updatedAt:"" },

        solo: {
          threat: 0,
          goalProgress: 0
        },

        pc: {
          name: "–ê–∫–∏",
          race: "",
          class: "",
          level: 1,
          hp: 10,
          maxHp: 10,
          drive: "",
          notes: ""
        },

        journal: [
          { id: uid(), date: nowRu(), title: "–°—Ç–∞—Ä—Ç", text: "–ù–∞—á–∞–ª–æ —Å–æ–ª–æ-–∫–∞–º–ø–∞–Ω–∏–∏. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –º–∏—Ä–µ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω—ã?" }
        ],

        quests: [],

        world: {
          npcs: [],
          locations: []
        },

        combat: {
          round: 1,
          turnIndex: 0,
          participants: []
        }
      };
    }

    function migrateState(s){
      const base = defaultState();
      if(!s || typeof s !== "object") return base;

      // shallow merge with nested merges
      const merged = {
        ...base,
        ...s,
        scene: { ...base.scene, ...(s.scene||{}) },
        solo: { ...base.solo, ...(s.solo||{}) },
        pc: { ...base.pc, ...(s.pc||{}) },
        world: { ...base.world, ...(s.world||{}), npcs: (s.world?.npcs)||[], locations: (s.world?.locations)||[] },
        combat: { ...base.combat, ...(s.combat||{}), participants: (s.combat?.participants)||[] },
      };

      // ensure arrays
      merged.journal = Array.isArray(merged.journal) ? merged.journal : base.journal;
      merged.quests = Array.isArray(merged.quests) ? merged.quests : [];
      return merged;
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        clearError();
        return migrateState(parsed);
      }catch(e){
        showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (storage/JSON). –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç, –∑–∞—Ç–µ–º –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–π—Ç–∞.");
        return defaultState();
      }
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        clearError();
        flashSaved();
      }catch(e){
        showError("–ù–µ —É–¥–∞—ë—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª storage –∏–ª–∏ –Ω–µ—Ç –º–µ—Å—Ç–∞). –°–¥–µ–ª–∞–π –≠–∫—Å–ø–æ—Ä—Ç.");
      }
    }

    let state = loadState();

    /**********************
     * UI: tabs + theme
     **********************/
    function openTab(id){
      $$("nav button[data-tab]").forEach(b=>b.classList.remove("active"));
      $$("main section").forEach(s=>s.classList.remove("active"));
      $(`nav button[data-tab="${id}"]`)?.classList.add("active");
      $(`#${id}`)?.classList.add("active");
    }
    $$("nav button[data-tab]").forEach(btn=>{
      btn.addEventListener("click", ()=>openTab(btn.dataset.tab));
    });

    function applyTheme(){
      document.body.classList.toggle("dark", state.theme === "dark");
      $("#themeBtn").textContent = state.theme === "dark" ? "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è" : "üåô –¢—ë–º–Ω–∞—è";
    }
    $("#themeBtn").addEventListener("click", ()=>{
      state.theme = (state.theme === "dark") ? "light" : "dark";
      saveState();
      applyTheme();
    });

    /**********************
     * Export / Import (plain JSON)
     **********************/
    $("#exportBtn").addEventListener("click", ()=>{
      try{
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `solo_campaign_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      }catch{
        showError("–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è.");
      }
    });

    $("#importBtn").addEventListener("click", ()=>$("#importFile").click());
    $("#importFile").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const imported = JSON.parse(String(r.result || "{}"));
          state = migrateState(imported);
          saveState();
          // –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ
          renderAll();
          showError("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ (—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É)");
          setTimeout(()=>clearError(), 1800);
        }catch{
          showError("–ù–µ–≤–µ—Ä–Ω—ã–π JSON-—Ñ–∞–π–ª –∏–º–ø–æ—Ä—Ç–∞.");
        }
        e.target.value = "";
      };
      r.readAsText(file);
    });

    /**********************
     * SOLO: Scene
     **********************/
    function renderScene(){
      $("#sceneTitle").value = state.scene.title || "";
      $("#sceneGoal").value = state.scene.goal || "";
      $("#sceneNotes").value = state.scene.notes || "";
      $("#scenePill").textContent = state.scene.updatedAt ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${state.scene.updatedAt}` : "–°—Ü–µ–Ω–∞";
    }

    function saveSceneFromInputs(){
      state.scene.title = $("#sceneTitle").value.trim();
      state.scene.goal = $("#sceneGoal").value.trim();
      state.scene.notes = $("#sceneNotes").value;
      state.scene.updatedAt = nowRu();
      scheduleSave();
      renderScene();
    }

    $("#saveSceneBtn").addEventListener("click", saveSceneFromInputs);

    $("#newSceneBtn").addEventListener("click", ()=>{
      state.scene = { title:"", goal:"", notes:"", updatedAt: nowRu() };
      scheduleSave();
      renderScene();
    });

    // live save (gentle)
    ["sceneTitle","sceneGoal","sceneNotes"].forEach(id=>{
      $("#"+id).addEventListener("input", ()=> {
        state.scene.updatedAt = nowRu();
        state.scene[id==="sceneTitle" ? "title" : id==="sceneGoal" ? "goal" : "notes"] = $("#"+id).value;
        scheduleSave();
        $("#scenePill").textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${state.scene.updatedAt}`;
      });
    });

    /**********************
     * SOLO: Oracle + Twist + Seeds
     **********************/
    const oddsMap = {
      very_unlikely: 0.2,
      unlikely: 0.35,
      "50": 0.5,
      likely: 0.65,
      very_likely: 0.8
    };

    function roll(n){ return Math.floor(Math.random()*n)+1; }

    function oracleYesNo(prob){
      // returns: {answer, nuance}
      const r = Math.random();
      const yes = r < prob;

      // nuance: "–∏..." or "–Ω–æ..."
      const nuanceRoll = roll(100);
      let nuance = "";
      if(nuanceRoll <= 12) nuance = yes ? "–î–ê, –∏..." : "–ù–ï–¢, –∏...";
      else if(nuanceRoll >= 89) nuance = yes ? "–î–ê, –Ω–æ..." : "–ù–ï–¢, –Ω–æ...";
      else nuance = yes ? "–î–ê" : "–ù–ï–¢";

      // rare exceptional
      const ex = roll(100);
      if(ex <= 4) nuance = yes ? "–û–ß–ï–ù–¨ –î–ê" : "–û–ß–ï–ù–¨ –ù–ï–¢";

      return { answer: yes, nuance };
    }

    const twistTable = [
      "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å–æ—é–∑–Ω–∏–∫ –≤–º–µ—à–∏–≤–∞–µ—Ç—Å—è",
      "–°–∫—Ä—ã—Ç–∞—è —Ü–µ–Ω–∞ —É—Å–ø–µ—Ö–∞",
      "–ö—Ç–æ-—Ç–æ —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç–æ–±–æ–π",
      "–ü–ª–∞–Ω –≤—Ä–∞–≥–∞ —É–∂–µ –≤ –¥–µ–π—Å—Ç–≤–∏–∏",
      "–¢–æ, —á—Ç–æ –∫–∞–∑–∞–ª–æ—Å—å –ø—Ä–∞–≤–¥–æ–π ‚Äî –ª–æ–∂—å",
      "–ú–µ—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è (–ø–æ–≥–æ–¥–∞/–º–∞–≥–∏—è/–æ–±–≤–∞–ª)",
      "–†–µ—Å—É—Ä—Å –∏—Å—Å—è–∫–∞–µ—Ç (—Å–≤–µ—Ç, –≤—Ä–µ–º—è, –µ–¥–∞)",
      "–ü—Ä–∏—Ö–æ–¥–∏—Ç —Å—Ä–æ—á–Ω–∞—è –≤–µ—Å—Ç—å",
      "–ù–µ–≤–∏–Ω–Ω—ã–π —Å—Ç—Ä–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π",
      "–¢—ã –Ω–∞—Ö–æ–¥–∏—à—å —É–ª–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –≤—Å—ë –º–µ–Ω—è–µ—Ç"
    ];

    const sceneSeeds = [
      "–ó–∞—Å–∞–¥–∞ –≤ —É–∑–∫–æ–º –º–µ—Å—Ç–µ",
      "–†–∞–∑–≥–æ–≤–æ—Ä —Å —Ç–µ–º, –∫—Ç–æ –∑–Ω–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ",
      "–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –¥–≤–µ—Ä—å –ø—Ä–∏–æ—Ç–∫—Ä—ã—Ç–∞",
      "–°—Ç–∞—Ä–∞—è –∫–∞—Ä—Ç–∞ –≤–µ–¥—ë—Ç –∫ –æ—à–∏–±–∫–µ",
      "–¢–∏—à–∏–Ω–∞ –ø–µ—Ä–µ–¥ –±—É—Ä–µ–π",
      "–û–±—Ä—è–¥ —É–∂–µ –Ω–∞—á–∞–ª—Å—è",
      "–¢—Ä–æ–ø–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å–≤–µ–∂–∏–º —Å–ª–µ–¥–∞–º",
      "–ö—Ç–æ-—Ç–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–º–æ—â–∏ –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –º–æ—Ç–∏–≤",
      "–°—Ç—Ä–∞–Ω–Ω—ã–π –∑–≤—É–∫ –∏–∑ –≥–ª—É–±–∏–Ω—ã",
      "–°–¥–µ–ª–∫–∞: –≤—ã–≥–æ–¥–Ω–æ, –Ω–æ –æ–ø–∞—Å–Ω–æ"
    ];

    $("#oracleRollBtn").addEventListener("click", ()=>{
      const q = $("#oracleQ").value.trim();
      const oddsKey = $("#oracleOdds").value;
      const prob = oddsKey === "50" ? 0.5 : oddsMap[oddsKey] ?? 0.5;

      const res = oracleYesNo(prob);
      const qPart = q ? `–í–æ–ø—Ä–æ—Å: ‚Äú${q}‚Äù ‚Üí ` : "";
      $("#oracleResult").textContent = qPart + res.nuance;

      // log into journal as a tiny line if question exists
      if(q){
        addQuickJournalLine(`–û—Ä–∞–∫—É–ª: ${q} ‚Üí ${res.nuance}`);
      }
    });

    $("#oracleClearBtn").addEventListener("click", ()=>{
      $("#oracleQ").value = "";
      $("#oracleResult").textContent = "‚Äî";
    });

    $("#twistBtn").addEventListener("click", ()=>{
      const t = twistTable[roll(twistTable.length)-1];
      $("#twistResult").textContent = t;
      addQuickJournalLine(`–¢–≤–∏—Å—Ç: ${t}`);
    });

    $("#sceneSeedBtn").addEventListener("click", ()=>{
      const s = sceneSeeds[roll(sceneSeeds.length)-1];
      $("#sceneSeedResult").textContent = s;
      addQuickJournalLine(`–°—Ü–µ–Ω–∞: ${s}`);
    });

    /**********************
     * Dice
     **********************/
    let lastDiceText = "";
    $("#rollDiceBtn").addEventListener("click", ()=>{
      const sides = asNum($("#dieSelect").value, 20);
      const count = clamp(asNum($("#dieCount").value, 1), 1, 50);
      const mod = asNum($("#dieMod").value, 0);

      const rolls = [];
      for(let i=0;i<count;i++) rolls.push(roll(sides));
      const sum = rolls.reduce((a,b)=>a+b,0);
      const total = sum + mod;

      lastDiceText = `${count}d${sides}${mod>=0?`+${mod}`:`${mod}`} ‚Üí [${rolls.join(", ")}] = ${total}`;
      $("#diceResult").textContent = lastDiceText;
      addQuickJournalLine(`–ë—Ä–æ—Å–æ–∫: ${lastDiceText}`);
    });

    $("#copyDiceBtn").addEventListener("click", async ()=>{
      if(!lastDiceText) return;
      try{
        await navigator.clipboard.writeText(lastDiceText);
        $("#diceResult").textContent = lastDiceText + " ‚úÖ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
        setTimeout(()=>$("#diceResult").textContent = lastDiceText, 900);
      }catch{
        // ignore
      }
    });

    /**********************
     * Generators: NPC / Loot
     **********************/
    const npcNames = ["–ê–ª—å–º–∞","–†–∞–≥–Ω–∞—Ä","–°–µ–ª–∏–Ω","–ö–∞–π","–ú–∏—Ä–∞","–û—Ä—Ä–µ–Ω","–¢–æ—Ä–∏–Ω","–í–µ—Ä–∞","–õ—é—Ü–∏–π","–ù–∞–π–ª–∞","–°–∏–≤","–≠–π—Ä–∏–∫"];
    const npcTraits = ["–Ω–µ—Ä–≤–Ω—ã–π","–≤–µ–∂–ª–∏–≤—ã–π","–∂–µ—Å—Ç–æ–∫–∏–π","—Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π","—É—Å—Ç–∞–ª—ã–π","—Ö–∏—Ç—Ä—ã–π","–Ω–∞–∏–≤–Ω—ã–π","–º—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π","—Ö–æ–ª–æ–¥–Ω—ã–π","–¥–æ–±—Ä—ã–π","–ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π","–æ–¥–µ—Ä–∂–∏–º—ã–π"];
    const npcGoal = ["—Ö–æ—á–µ—Ç –¥–µ–Ω—å–≥–∏","–∏—â–µ—Ç –∑–∞—â–∏—Ç—É","–º–µ—á—Ç–∞–µ—Ç –æ —Å–ª–∞–≤–µ","–±–æ–∏—Ç—Å—è —Ä–∞–∑–æ–±–ª–∞—á–µ–Ω–∏—è","–æ—Ö–æ—Ç–∏—Ç—Å—è –∑–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º","—Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ","–∂–∞–∂–¥–µ—Ç –º–µ—Å—Ç–∏","—Ö–æ—á–µ—Ç —Å–¥–µ–ª–∫–∏","–∏—â–µ—Ç –ø—Ä–æ–ø–∞–≤—à–µ–≥–æ","—Å–ª—É–∂–∏—Ç –∫—É–ª—å—Ç—É"];
    const lootTable = ["–∫–æ–ª—å—Ü–æ —Å –≥–µ—Ä–±–æ–º","–ø–∏—Å—å–º–æ —Å –ø–µ—á–∞—Ç—å—é","–∫–ª—é—á –Ω–µ–æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã","–∑–µ–ª—å–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞","–∫–∞—Ä—Ç–∞ —Å –ø–æ–º–µ—Ç–∫–∞–º–∏","–∞–º—É–ª–µ—Ç —Å —Ç—Ä–µ—â–∏–Ω–æ–π","–º–µ—à–æ—á–µ–∫ –º–æ–Ω–µ—Ç","—Å—Ç—Ä–∞–Ω–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª","–æ–±–ª–æ–º–æ–∫ –º–µ—á–∞","–¥–Ω–µ–≤–Ω–∏–∫ —Å –≤—ã—Ä–≤–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏"];

    function genNpcText(){
      const name = npcNames[roll(npcNames.length)-1];
      const tr = npcTraits[roll(npcTraits.length)-1];
      const g = npcGoal[roll(npcGoal.length)-1];
      return `${name} ‚Äî ${tr}, ${g}`;
    }

    $("#npcBtn").addEventListener("click", ()=>{
      const t = genNpcText();
      $("#npcResult").textContent = t;
      scheduleSave();
    });

    $("#npcToWorldBtn").addEventListener("click", ()=>{
      const t = $("#npcResult").textContent.trim();
      if(!t || t==="‚Äî") return;
      state.world.npcs.unshift({ id: uid(), name: t.split("‚Äî")[0].trim(), role: t, notes:"" });
      scheduleSave();
      renderWorld();
      openTab("world");
    });

    $("#lootBtn").addEventListener("click", ()=>{
      const t = lootTable[roll(lootTable.length)-1];
      $("#lootResult").textContent = t;
      scheduleSave();
    });

    $("#logLootBtn").addEventListener("click", ()=>{
      const t = $("#lootResult").textContent.trim();
      if(!t || t==="‚Äî") return;
      addQuickJournalLine(`–ù–∞—Ö–æ–¥–∫–∞: ${t}`);
    });

    /**********************
     * Journal
     **********************/
    function addQuickJournalLine(line){
      // put into latest entry (top) or create if none
      if(!state.journal.length){
        state.journal.unshift({ id: uid(), date: nowRu(), title: "–ó–∞–º–µ—Ç–∫–∏", text: "" });
      }
      state.journal[0].text = (state.journal[0].text ? state.journal[0].text + "\n" : "") + "‚Ä¢ " + line;
      scheduleSave();
      renderJournal();
    }

    function addJournalEntry(){
      state.journal.unshift({
        id: uid(),
        date: nowRu(),
        title: "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å",
        text: ""
      });
      scheduleSave();
      renderJournal();
    }

    function deleteJournalEntry(id){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∂—É—Ä–Ω–∞–ª–∞?")) return;
      state.journal = state.journal.filter(x=>x.id!==id);
      scheduleSave();
      renderJournal();
    }

    function renderJournal(){
      const grid = $("#sessionsGrid");
      grid.innerHTML = "";
      if(state.journal.length === 0){
        grid.innerHTML = `<div class="card"><b>–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</b><div class="hint">–ù–∞–∂–º–∏ ‚Äú–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å‚Äù.</div></div>`;
        return;
      }

      for(const s of state.journal){
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="row">
            <span class="pill">${s.date}</span>
            <div class="spacer"></div>
            <button class="btn small danger" data-del>üóëÔ∏è</button>
          </div>

          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input data-title>

          <label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea data-text rows="8" placeholder="–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å? –ö–∞–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è? –ö–∞–∫–∏–µ –Ω–æ–≤—ã–µ –∑–∞—Ü–µ–ø–∫–∏?"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn ghost small" data-to-scene>‚ÜóÔ∏è –í —Å—Ü–µ–Ω—É</button>
          </div>
        `;

        const title = el.querySelector("[data-title]");
        const text = el.querySelector("[data-text]");
        title.value = s.title || "";
        text.value = s.text || "";

        el.querySelector("[data-del]").addEventListener("click", ()=>deleteJournalEntry(s.id));

        title.addEventListener("input", ()=>{
          s.title = title.value;
          scheduleSave();
        });
        text.addEventListener("input", ()=>{
          s.text = text.value;
          scheduleSave();
        });

        el.querySelector("[data-to-scene]").addEventListener("click", ()=>{
          // quick copy last lines into scene notes
          state.scene.notes = (state.scene.notes ? state.scene.notes + "\n\n" : "") + `–ò–∑ –∂—É—Ä–Ω–∞–ª–∞ (${s.title}):\n` + (s.text || "");
          state.scene.updatedAt = nowRu();
          scheduleSave();
          renderScene();
          openTab("dashboard");
        });

        grid.appendChild(el);
      }
    }

    $("#addSessionBtn").addEventListener("click", addJournalEntry);

    /**********************
     * Character (single PC)
     **********************/
    function renderPc(){
      const pc = state.pc;
      $("#pcName").value = pc.name || "";
      $("#pcRace").value = pc.race || "";
      $("#pcClass").value = pc.class || "";
      $("#pcLevel").value = asNum(pc.level, 1);
      $("#pcHp").value = asNum(pc.hp, 0);
      $("#pcMaxHp").value = asNum(pc.maxHp, 0);
      $("#pcDrive").value = pc.drive || "";
      $("#pcNotes").value = pc.notes || "";

      $("#threat").value = clamp(asNum(state.solo.threat,0), 0, 10);
      $("#goalProg").value = clamp(asNum(state.solo.goalProgress,0), 0, 10);
      $("#threatPill").textContent = String($("#threat").value);
      $("#goalProgPill").textContent = String($("#goalProg").value);
    }

    function savePcFromInputs(){
      const pc = state.pc;
      pc.name = $("#pcName").value.trim() || "–ê–∫–∏";
      pc.race = $("#pcRace").value.trim();
      pc.class = $("#pcClass").value.trim();
      pc.level = clamp(asNum($("#pcLevel").value,1), 1, 20);

      pc.maxHp = Math.max(0, asNum($("#pcMaxHp").value,10));
      pc.hp = clamp(asNum($("#pcHp").value,10), 0, pc.maxHp);

      pc.drive = $("#pcDrive").value.trim();
      pc.notes = $("#pcNotes").value;

      state.solo.threat = clamp(asNum($("#threat").value,0), 0, 10);
      state.solo.goalProgress = clamp(asNum($("#goalProg").value,0), 0, 10);

      scheduleSave();
      renderPc();
      syncPcToCombat();
      renderCombat();
    }

    $("#savePcBtn").addEventListener("click", savePcFromInputs);

    ["pcName","pcRace","pcClass","pcLevel","pcHp","pcMaxHp","pcDrive","pcNotes"].forEach(id=>{
      $("#"+id).addEventListener("input", savePcFromInputs);
    });
    $("#threat").addEventListener("input", ()=>{
      state.solo.threat = asNum($("#threat").value,0);
      $("#threatPill").textContent = String(state.solo.threat);
      scheduleSave();
    });
    $("#goalProg").addEventListener("input", ()=>{
      state.solo.goalProgress = asNum($("#goalProg").value,0);
      $("#goalProgPill").textContent = String(state.solo.goalProgress);
      scheduleSave();
    });

    $("#soloCheckpointBtn").addEventListener("click", ()=>{
      const pc = state.pc;
      addJournalEntry();
      state.journal[0].title = `–ß–µ–∫–ø–æ–∏–Ω—Ç ‚Äî ${nowRu()}`;
      state.journal[0].text =
`–°—Ü–µ–Ω–∞: ${state.scene.title || "‚Äî"}
–¶–µ–ª—å: ${state.scene.goal || "‚Äî"}
–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${state.solo.threat}/10
–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏: ${state.solo.goalProgress}/10
PC: ${pc.name} (${pc.class||"‚Äî"} ${pc.level}) HP ${pc.hp}/${pc.maxHp}
–ö–ª—é—á–µ–≤–æ–µ:`;
      scheduleSave();
      renderJournal();
      openTab("journal");
    });

    $("#soloPushBtn").addEventListener("click", ()=>{
      state.solo.threat = clamp(state.solo.threat + 1, 0, 10);
      scheduleSave();
      renderPc();
      const t = twistTable[roll(twistTable.length)-1];
      $("#twistResult").textContent = t;
      addQuickJournalLine(`–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Üë (${state.solo.threat}/10). –†–µ–∞–∫—Ü–∏—è –º–∏—Ä–∞: ${t}`);
      openTab("dashboard");
    });

    $("#resetCharBtn").addEventListener("click", ()=>{
      if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫ —à–∞–±–ª–æ–Ω—É?")) return;
      state.pc = defaultState().pc;
      scheduleSave();
      renderPc();
      syncPcToCombat();
      renderCombat();
    });

    /**********************
     * Quests
     **********************/
    function addQuest(){
      state.quests.unshift({ id: uid(), title:"–ù–æ–≤—ã–π –∫–≤–µ—Å—Ç", status:"active", notes:"", progress:0 });
      scheduleSave();
      renderQuests();
    }

    function deleteQuest(id){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç?")) return;
      state.quests = state.quests.filter(q=>q.id!==id);
      scheduleSave();
      renderQuests();
    }

    function renderQuests(){
      const grid = $("#questsGrid");
      grid.innerHTML = "";
      if(state.quests.length === 0){
        grid.innerHTML = `<div class="card"><b>–ö–≤–µ—Å—Ç–æ–≤ –Ω–µ—Ç.</b><div class="hint">–°–æ–∑–¥–∞–π –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç –∏ –æ–¥–∏–Ω –ø–æ–±–æ—á–Ω—ã–π ‚Äî –±–æ–ª—å—à–µ –Ω–µ –Ω–∞–¥–æ.</div></div>`;
        return;
      }

      for(const q of state.quests){
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="row">
            <span class="pill">${q.status==="done" ? "‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω" : q.status==="paused" ? "‚è∏Ô∏è –ü–∞—É–∑–∞" : "üü° –ê–∫—Ç–∏–≤–µ–Ω"}</span>
            <div class="spacer"></div>
            <button class="btn small danger" data-del>üóëÔ∏è</button>
          </div>

          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input data-title>

          <div class="two">
            <div>
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select data-status>
                <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                <option value="paused">–ü–∞—É–∑–∞</option>
                <option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
              </select>
            </div>
            <div>
              <label>–ü—Ä–æ–≥—Ä–µ—Å—Å (0‚Äì10)</label>
              <input data-prog type="range" min="0" max="10">
              <div class="row" style="justify-content:space-between; margin-top:6px;">
                <span class="muted">0</span>
                <span class="pill" data-progPill>0</span>
                <span class="muted">10</span>
              </div>
            </div>
          </div>

          <label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea data-notes rows="5" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å? –ö–∞–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è?">${q.notes||""}</textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn ghost small" data-log>üìù –í –∂—É—Ä–Ω–∞–ª</button>
          </div>
        `;

        const title = el.querySelector("[data-title]");
        const status = el.querySelector("[data-status]");
        const prog = el.querySelector("[data-prog]");
        const progPill = el.querySelector("[data-progPill]");
        const notes = el.querySelector("[data-notes]");

        title.value = q.title || "";
        status.value = q.status || "active";
        prog.value = clamp(asNum(q.progress,0), 0, 10);
        progPill.textContent = String(prog.value);

        el.querySelector("[data-del]").addEventListener("click", ()=>deleteQuest(q.id));

        title.addEventListener("input", ()=>{ q.title = title.value; scheduleSave(); });
        status.addEventListener("change", ()=>{ q.status = status.value; scheduleSave(); renderQuests(); });
        prog.addEventListener("input", ()=>{ q.progress = asNum(prog.value,0); progPill.textContent = String(q.progress); scheduleSave(); });
        notes.addEventListener("input", ()=>{ q.notes = notes.value; scheduleSave(); });

        el.querySelector("[data-log]").addEventListener("click", ()=>{
          addQuickJournalLine(`–ö–≤–µ—Å—Ç: ${q.title} ‚Äî —Å—Ç–∞—Ç—É—Å: ${q.status}, –ø—Ä–æ–≥—Ä–µ—Å—Å: ${q.progress}/10`);
        });

        grid.appendChild(el);
      }
    }

    $("#addQuestBtn").addEventListener("click", addQuest);

    /**********************
     * World: NPC + Locations
     **********************/
    function addNpc(){
      state.world.npcs.unshift({ id: uid(), name: "–ù–æ–≤—ã–π NPC", role: "", notes: "" });
      scheduleSave();
      renderWorld();
    }
    function addLoc(){
      state.world.locations.unshift({ id: uid(), name: "–ù–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è", tags: "", notes: "" });
      scheduleSave();
      renderWorld();
    }

    function renderWorld(){
      const npcGrid = $("#npcGrid");
      const locGrid = $("#locGrid");
      npcGrid.innerHTML = "";
      locGrid.innerHTML = "";

      if(state.world.npcs.length === 0){
        npcGrid.innerHTML = `<div class="card"><b>–ü–æ–∫–∞ –Ω–µ—Ç NPC.</b><div class="hint">–ù–∞–∂–º–∏ ‚ÄúNPC‚Äù –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤ –°–æ–ª–æ.</div></div>`;
      }else{
        for(const n of state.world.npcs){
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <div class="row">
              <span class="pill">NPC</span>
              <div class="spacer"></div>
              <button class="btn small danger" data-del>üóëÔ∏è</button>
            </div>
            <label>–ò–º—è</label>
            <input data-name>
            <label>–†–æ–ª—å / –∫—Ä—é—á–æ–∫</label>
            <input data-role placeholder="–ö—Ç–æ –æ–Ω –∏ –∑–∞—á–µ–º –≤–∞–∂–µ–Ω?">
            <label>–ó–∞–º–µ—Ç–∫–∏</label>
            <textarea data-notes rows="4"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn ghost small" data-log>üìù –í –∂—É—Ä–Ω–∞–ª</button>
            </div>
          `;
          const name = el.querySelector("[data-name]");
          const role = el.querySelector("[data-role]");
          const notes = el.querySelector("[data-notes]");
          name.value = n.name || "";
          role.value = n.role || "";
          notes.value = n.notes || "";

          el.querySelector("[data-del]").addEventListener("click", ()=>{
            if(!confirm("–£–¥–∞–ª–∏—Ç—å NPC?")) return;
            state.world.npcs = state.world.npcs.filter(x=>x.id!==n.id);
            scheduleSave();
            renderWorld();
          });

          name.addEventListener("input", ()=>{ n.name = name.value; scheduleSave(); });
          role.addEventListener("input", ()=>{ n.role = role.value; scheduleSave(); });
          notes.addEventListener("input", ()=>{ n.notes = notes.value; scheduleSave(); });

          el.querySelector("[data-log]").addEventListener("click", ()=>{
            addQuickJournalLine(`NPC: ${n.name} ‚Äî ${n.role || "‚Äî"}`);
          });

          npcGrid.appendChild(el);
        }
      }

      if(state.world.locations.length === 0){
        locGrid.innerHTML = `<div class="card"><b>–ü–æ–∫–∞ –Ω–µ—Ç –ª–æ–∫–∞—Ü–∏–π.</b><div class="hint">–ù–∞–∂–º–∏ ‚Äú–õ–æ–∫–∞—Ü–∏—è‚Äù –∏ –≤–µ–¥–∏ –∑–∞–º–µ—Ç–∫–∏.</div></div>`;
      }else{
        for(const l of state.world.locations){
          const el = document.createElement("div");
          el.className = "card";
          el.innerHTML = `
            <div class="row">
              <span class="pill">–õ–æ–∫–∞—Ü–∏—è</span>
              <div class="spacer"></div>
              <button class="btn small danger" data-del>üóëÔ∏è</button>
            </div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input data-name>
            <label>–¢–µ–≥–∏</label>
            <input data-tags placeholder="—Ä—É–∏–Ω—ã, –≥–æ—Ä–æ–¥, –ª–µ—Å...">
            <label>–ó–∞–º–µ—Ç–∫–∏</label>
            <textarea data-notes rows="4"></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn ghost small" data-log>üìù –í –∂—É—Ä–Ω–∞–ª</button>
            </div>
          `;
          const name = el.querySelector("[data-name]");
          const tags = el.querySelector("[data-tags]");
          const notes = el.querySelector("[data-notes]");
          name.value = l.name || "";
          tags.value = l.tags || "";
          notes.value = l.notes || "";

          el.querySelector("[data-del]").addEventListener("click", ()=>{
            if(!confirm("–£–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é?")) return;
            state.world.locations = state.world.locations.filter(x=>x.id!==l.id);
            scheduleSave();
            renderWorld();
          });

          name.addEventListener("input", ()=>{ l.name = name.value; scheduleSave(); });
          tags.addEventListener("input", ()=>{ l.tags = tags.value; scheduleSave(); });
          notes.addEventListener("input", ()=>{ l.notes = notes.value; scheduleSave(); });

          el.querySelector("[data-log]").addEventListener("click", ()=>{
            addQuickJournalLine(`–õ–æ–∫–∞—Ü–∏—è: ${l.name} (${l.tags||"–±–µ–∑ —Ç–µ–≥–æ–≤"})`);
          });

          locGrid.appendChild(el);
        }
      }
    }

    $("#addNpcBtn").addEventListener("click", addNpc);
    $("#addLocBtn").addEventListener("click", addLoc);

    /**********************
     * Combat (solo-friendly)
     **********************/
    function syncPcToCombat(){
      const pc = state.pc;
      const p = state.combat.participants.find(x=>x.type==="pc");
      if(!p) return;
      p.name = pc.name || "–ü–µ—Ä—Å–æ–Ω–∞–∂";
      p.maxHp = asNum(pc.maxHp, 10);
      p.hp = clamp(asNum(pc.hp,10), 0, p.maxHp);
      scheduleSave();
    }

    function ensurePcInCombat(){
      const pc = state.pc;
      let p = state.combat.participants.find(x=>x.type==="pc");
      if(p) return p;
      p = {
        id: uid(),
        type: "pc",
        name: pc.name || "–ü–µ—Ä—Å–æ–Ω–∞–∂",
        hp: asNum(pc.hp,10),
        maxHp: asNum(pc.maxHp,10),
        initMod: 0,
        initRoll: null,
        initTotal: null,
        status: "",
        notes: ""
      };
      state.combat.participants.unshift(p);
      scheduleSave();
      return p;
    }

    $("#addPcToCombatBtn").addEventListener("click", ()=>{
      ensurePcInCombat();
      renderCombat();
      renderInitOrder();
    });

    $("#syncPcCombatBtn").addEventListener("click", ()=>{
      ensurePcInCombat();
      syncPcToCombat();
      renderCombat();
      renderInitOrder();
    });

    $("#addMobBtn").addEventListener("click", ()=>{
      const name = ($("#mobName").value || "").trim() || "–í—Ä–∞–≥";
      const count = clamp(asNum($("#mobCount").value, 1), 1, 30);
      const hp = Math.max(0, asNum($("#mobMaxHp").value, 1));
      const mod = asNum($("#mobInitMod").value, 0);

      for(let i=1;i<=count;i++){
        state.combat.participants.push({
          id: uid(),
          type: "mob",
          name: count>1 ? `${name} #${i}` : name,
          hp, maxHp: hp,
          initMod: mod,
          initRoll: null,
          initTotal: null,
          status: "",
          notes: ""
        });
      }
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    $("#clearCombatBtn").addEventListener("click", ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –±–æ–π?")) return;
      state.combat = { round: 1, turnIndex: 0, participants: [] };
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    function rollInitiative(){
      for(const p of state.combat.participants){
        p.initRoll = roll(20);
        p.initTotal = p.initRoll + asNum(p.initMod, 0);
      }
      sortByInit();
      state.combat.turnIndex = 0;
      scheduleSave();
      renderCombat();
      renderInitOrder();
    }

    function sortByInit(){
      state.combat.participants.sort((a,b)=>{
        const dt = (asNum(b.initTotal,-999) - asNum(a.initTotal,-999));
        if(dt !== 0) return dt;
        const dr = (asNum(b.initRoll,-999) - asNum(a.initRoll,-999));
        if(dr !== 0) return dr;
        return String(a.name).localeCompare(String(b.name));
      });
      state.combat.turnIndex = clamp(state.combat.turnIndex, 0, Math.max(0, state.combat.participants.length-1));
    }

    $("#rollInitBtn").addEventListener("click", ()=>{
      if(state.combat.participants.length === 0){
        showError("–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –±–æ—è.");
        setTimeout(()=>clearError(), 1200);
        return;
      }
      rollInitiative();
    });

    $("#sortInitBtn").addEventListener("click", ()=>{
      sortByInit();
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    $("#nextTurnBtn").addEventListener("click", ()=>{
      const n = state.combat.participants.length;
      if(n === 0) return;
      state.combat.turnIndex = (state.combat.turnIndex + 1) % n;
      if(state.combat.turnIndex === 0) state.combat.round += 1;
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    $("#prevTurnBtn").addEventListener("click", ()=>{
      const n = state.combat.participants.length;
      if(n === 0) return;
      state.combat.turnIndex = (state.combat.turnIndex - 1 + n) % n;
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    $("#newRoundBtn").addEventListener("click", ()=>{
      if(state.combat.participants.length === 0) return;
      state.combat.round += 1;
      state.combat.turnIndex = 0;
      scheduleSave();
      renderCombat();
      renderInitOrder();
    });

    function adjustHp(pid, delta){
      const p = state.combat.participants.find(x=>x.id===pid);
      if(!p) return;
      p.hp = clamp(asNum(p.hp,0) + delta, 0, Math.max(0, asNum(p.maxHp,0)));

      // sync back to pc
      if(p.type === "pc"){
        state.pc.hp = p.hp;
        state.pc.maxHp = Math.max(0, asNum(p.maxHp,0));
        renderPc();
      }

      scheduleSave();
      renderCombat();
      renderInitOrder();
    }

    function removeParticipant(pid){
      if(!confirm("–£–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –±–æ—è?")) return;
      state.combat.participants = state.combat.participants.filter(x=>x.id!==pid);
      state.combat.turnIndex = clamp(state.combat.turnIndex, 0, Math.max(0, state.combat.participants.length-1));
      scheduleSave();
      renderCombat();
      renderInitOrder();
    }

    function renderInitOrder(){
      const box = $("#initOrder");
      box.innerHTML = "";
      if(state.combat.participants.length === 0) return;

      state.combat.participants.forEach((p,i)=>{
        const el = document.createElement("div");
        el.className = "init-item" + (i===state.combat.turnIndex ? " current" : "");
        el.textContent = `${i+1}. ${p.name} (${p.initTotal ?? "‚Äî"})`;
        el.title = "–ö–ª–∏–∫ ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥–æ–º";
        el.addEventListener("click", ()=>{
          state.combat.turnIndex = i;
          scheduleSave();
          renderCombat();
          renderInitOrder();
        });
        box.appendChild(el);
      });

      $("#roundPill").textContent = `–†–∞—É–Ω–¥: ${state.combat.round}`;
      $("#turnPill").textContent = `–•–æ–¥: ${state.combat.participants[state.combat.turnIndex]?.name || "‚Äî"}`;
    }

    function renderCombat(){
      const host = $("#combatGrid");
      host.innerHTML = "";

      if(state.combat.participants.length === 0){
        host.innerHTML = `<div class="card"><b>–ë–æ–π –ø—É—Å—Ç.</b><div class="hint">–î–æ–±–∞–≤—å ‚Äú–º–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞‚Äù –∏ –≤—Ä–∞–≥–æ–≤.</div></div>`;
        $("#roundPill").textContent = `–†–∞—É–Ω–¥: ${state.combat.round}`;
        $("#turnPill").textContent = `–•–æ–¥: ‚Äî`;
        return;
      }

      state.combat.participants.forEach((p, i)=>{
        const el = document.createElement("div");
        el.className = "card" + (i===state.combat.turnIndex ? " turn" : "");
        const init = p.initTotal != null ? `${p.initTotal} (d20:${p.initRoll} + ${asNum(p.initMod,0)})` : "‚Äî";

        el.innerHTML = `
          <div class="row">
            <b>${p.name}</b>
            <div class="spacer"></div>
            <span class="pill">${p.type==="pc" ? "–¢—ã" : "–í—Ä–∞–≥"}</span>
            <button class="btn small danger" data-rm>‚úñ</button>
          </div>

          <div class="row" style="margin-top:8px;">
            <span class="pill">–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: ${init}</span>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <label>HP</label>
              <input data-hp type="number" min="0" value="${asNum(p.hp,0)}">
            </div>
            <div>
              <label>Max HP</label>
              <input data-max type="number" min="0" value="${asNum(p.maxHp,0)}">
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn small danger" data-dmg5>-5</button>
            <button class="btn small danger" data-dmg1>-1</button>
            <button class="btn small success" data-heal1>+1</button>
            <button class="btn small success" data-heal5>+5</button>
            <div class="spacer"></div>
            <button class="btn small ghost" data-focus>–•–æ–¥</button>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <label>Init –º–æ–¥</label>
              <input data-mod type="number" value="${asNum(p.initMod,0)}">
            </div>
            <div>
              <label>–°—Ç–∞—Ç—É—Å</label>
              <input data-status value="${p.status||""}" placeholder="–æ–≥–ª—É—à—ë–Ω, —è–¥...">
            </div>
          </div>

          <label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea data-notes rows="3" placeholder="–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è, —Ç—Ä—é–∫, —Ü–µ–ª—å...">${p.notes||""}</textarea>
        `;

        el.querySelector("[data-rm]").addEventListener("click", ()=>removeParticipant(p.id));
        el.querySelector("[data-dmg5]").addEventListener("click", ()=>adjustHp(p.id, -5));
        el.querySelector("[data-dmg1]").addEventListener("click", ()=>adjustHp(p.id, -1));
        el.querySelector("[data-heal1]").addEventListener("click", ()=>adjustHp(p.id, +1));
        el.querySelector("[data-heal5]").addEventListener("click", ()=>adjustHp(p.id, +5));
        el.querySelector("[data-focus]").addEventListener("click", ()=>{
          state.combat.turnIndex = i;
          scheduleSave();
          renderCombat();
          renderInitOrder();
        });

        const hp = el.querySelector("[data-hp]");
        const max = el.querySelector("[data-max]");
        const mod = el.querySelector("[data-mod]");
        const st = el.querySelector("[data-status]");
        const nt = el.querySelector("[data-notes]");

        hp.addEventListener("input", ()=>{
          p.hp = clamp(asNum(hp.value,0), 0, Math.max(0, asNum(p.maxHp,0)));
          if(p.type==="pc"){ state.pc.hp = p.hp; renderPc(); }
          scheduleSave();
          renderInitOrder();
        });

        max.addEventListener("input", ()=>{
          p.maxHp = Math.max(0, asNum(max.value,0));
          p.hp = clamp(asNum(p.hp,0), 0, p.maxHp);
          hp.value = String(p.hp);
          if(p.type==="pc"){ state.pc.maxHp = p.maxHp; state.pc.hp = p.hp; renderPc(); }
          scheduleSave();
          renderInitOrder();
        });

        mod.addEventListener("input", ()=>{
          p.initMod = asNum(mod.value,0);
          scheduleSave();
        });

        st.addEventListener("input", ()=>{
          p.status = st.value;
          scheduleSave();
        });

        nt.addEventListener("input", ()=>{
          p.notes = nt.value;
          scheduleSave();
        });

        host.appendChild(el);
      });

      $("#roundPill").textContent = `–†–∞—É–Ω–¥: ${state.combat.round}`;
      $("#turnPill").textContent = `–•–æ–¥: ${state.combat.participants[state.combat.turnIndex]?.name || "‚Äî"}`;
    }

    /**********************
     * Map: zoom + drag (no storage)
     **********************/
    let mapObjectUrl = null;
    let mapScale = 1;
    let mapPos = {x:0, y:0};
    let dragging = false;
    let dragStart = {x:0, y:0};

    const mapImg = $("#mapImg");
    const mapContainer = $("#mapContainer");

    $("#mapFile").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      if(mapObjectUrl) URL.revokeObjectURL(mapObjectUrl);
      mapObjectUrl = URL.createObjectURL(file);

      mapImg.src = mapObjectUrl;
      mapImg.style.display = "block";
      mapScale = 1;
      mapPos = {x:0,y:0};
      mapImg.style.transform = `translate(${mapPos.x}px,${mapPos.y}px) scale(${mapScale})`;
    });

    $("#clearMapBtn").addEventListener("click", ()=>{
      if(mapObjectUrl) URL.revokeObjectURL(mapObjectUrl);
      mapObjectUrl = null;
      mapImg.removeAttribute("src");
      mapImg.style.display = "none";
      $("#mapFile").value = "";
    });

    mapImg.addEventListener("mousedown", (e)=>{
      dragging = true;
      dragStart = { x: e.clientX - mapPos.x, y: e.clientY - mapPos.y };
      mapImg.classList.add("dragging");
      e.preventDefault();
    });
    document.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      mapPos.x = e.clientX - dragStart.x;
      mapPos.y = e.clientY - dragStart.y;
      mapImg.style.transform = `translate(${mapPos.x}px,${mapPos.y}px) scale(${mapScale})`;
    });
    document.addEventListener("mouseup", ()=>{
      dragging = false;
      mapImg.classList.remove("dragging");
    });
    mapContainer.addEventListener("wheel", (e)=>{
      if(mapImg.style.display === "none") return;
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      mapScale = clamp(mapScale * delta, 0.25, 6);
      mapImg.style.transform = `translate(${mapPos.x}px,${mapPos.y}px) scale(${mapScale})`;
    }, { passive:false });

    /**********************
     * Render all
     **********************/
    function renderAll(){
      applyTheme();
      renderScene();
      renderPc();
      renderJournal();
      renderQuests();
      renderWorld();
      renderCombat();
      renderInitOrder();

      // seed result boxes if empty
      if(!$("#twistResult").textContent.trim()) $("#twistResult").textContent = "‚Äî";
      if(!$("#sceneSeedResult").textContent.trim()) $("#sceneSeedResult").textContent = "‚Äî";
      if(!$("#oracleResult").textContent.trim()) $("#oracleResult").textContent = "‚Äî";
      if(!$("#npcResult").textContent.trim()) $("#npcResult").textContent = "‚Äî";
      if(!$("#lootResult").textContent.trim()) $("#lootResult").textContent = "‚Äî";
      if(!$("#diceResult").textContent.trim()) $("#diceResult").textContent = "‚Äî";
    }

    // initial render
    renderAll();
    saveState(); // ensure storage initialized
  </script>
</body>
</html>
